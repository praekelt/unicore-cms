<div metal:use-macro="view.global_template">
  <div metal:fill-slot="navbar">
    <div class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <li class="active"><a href="#">Home</a></li>
        <li><a href="/admin/add/">Add Content</a></li>
      </ul>
    </div>
  </div><!--/.navbar -->

  <div metal:fill-slot="content">
    <div class="row">
      <div class="content">
        <div id="pages" class="col-md-8"></div>
        <div id="categories" class="col-md-4"></div>
      </div>
    </div>
    <div class="row"></div>
    <br/>

    <div class="modal fade" id="page_edit">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title">Edit page</h4>
          </div>
          <div class="modal-body">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary">Save changes</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div class="modal fade" id="category_edit">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title">Edit category</h4>
          </div>
          <div class="modal-body">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary">Save changes</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
  </div><!-- /.slot-content -->

  <script metal:fill-slot="js">
    function load_pages(){
      $.get('/api/pages.json').done(function(data){
        var pages_div = $('#pages').html('<h2>Pages</h2>');

        var ul = $('<ul/>').addClass('nav nav-stacked');
        $.each(data, function(key, value){
          var primary_category_title = value.primary_category ? value.primary_category.title : '';
          $('<li/>')
            .append(
              $('<a/>').attr({
                href: '#',
                uuid: value.uuid
              })
              .append($('<span/>').addClass('label label-xs label-primary').text(primary_category_title))
              .append('&nbsp;')
              .append(value.title))
            .appendTo(ul);
        });
        ul.appendTo(pages_div);

      });
    }
    function load_categories(){
      $.get('/api/categories.json').done(function(data){
        var pages_div = $('#categories').html('<h2>Categories</h2>');
        var pages_div = $('#categories').html('<h2>Categories</h2>');

        var ul = $('<ul/>').addClass('nav nav-stacked');
        $.each(data, function(key, value){
          $('<li/>')
            .append(
              $('<a/>').attr({
                href: '#',
                uuid: value.uuid
              })
              .append(value.title))
            .appendTo(ul);
        });
        ul.appendTo(pages_div);

      });
    }

    function build_dropdown_options(current, categories, opts){
      var dropdown = new Array();
      dropdown.push($('<option/>', {value: '', text: ''}));

      for(var i in categories){
        var cat = categories[i]
        if (current && cat.uuid == current.uuid){
          dropdown.push($('<option/>', {value: cat.uuid, text: cat.title, selected: 'selected'}));
        }else{
          dropdown.push($('<option/>', {value: cat.uuid, text: cat.title}));
        }
      }
      return dropdown;
    }

    function edit_page(uuid){
      var page_url = '/api/pages/'+uuid+'.json';

      $.get('/api/categories.json').done(function(categories){
        $.get(page_url).done(function(data){
          $('#page_edit .modal-body').html('').append(
            $('<div/>', {class: 'form-group'}).append(
              $('<form/>', {action: page_url, method: 'PUT'}).append(
                $('<label/>', {for: 'title', text: 'Title'}),
                $('<input />',
                  {
                    id: 'title',
                    name: 'title',
                    placeholder: 'Title',
                    type: 'text',
                    value: data.title
                  }).addClass('form-control'),
                $('<label/>', {for: 'content', text: 'Content'}),
                $('<textarea />',
                  {
                    id: 'content',
                    name: 'content',
                    placeholder: 'Content',
                    rows: '10'
                  }).addClass('form-control').text(data.content),
                $('<label/>', {for: 'primary_category', text: 'Primary Category'}),
                $('<select />',
                  {
                    id: 'primary_category',
                    name: 'primary_category'
                  }).addClass('form-control').append(
                    build_dropdown_options(data.primary_category, categories)
                  )
              )
            )
          );

          $('#page_edit').modal();
        });
      });
    }

    function edit_category(uuid){
      var category_url = '/api/categories/'+uuid+'.json';

      $.get(category_url).done(function(data){
        $('#category_edit .modal-body').html('').append(
          $('<div/>', {class: 'form-group'}).append(
            $('<form/>', {action: category_url, method: 'PUT'}).append(
              $('<input />',
                {
                  id: 'title',
                  name: 'title',
                  placeholder: 'Title',
                  type: 'text',
                  value: data.title
                }).addClass('form-control')
            )
          )
        );

        $('#category_edit').modal();
      });
    }

    function submit_form(e, form, on_success){
      var postData = form.serializeObject();
      var formURL = form.attr("action");
      $.ajax(
      {
          url : formURL,
          contentType : 'application/json',
          type: "PUT",
          data : JSON.stringify(postData)
      }).done(on_success);
      e.preventDefault(); //STOP default action
    }

    $(function(){
      load_pages();
      load_categories();

      $('#pages').on('click', 'li a', function(e){
        e.preventDefault();
        edit_page($(this).attr('uuid'));
      });
      $('#categories').on('click', 'li a', function(e){
        e.preventDefault();
        edit_category($(this).attr('uuid'));
      });

      $('#page_edit').on('submit', 'form', function(e){
        submit_form(e, $(this), function(data){
          $('#page_edit').modal('hide');
          load_pages();
        });
      });
      $('#category_edit').on('submit', 'form', function(e){
        submit_form(e, $(this), function(data){
          $('#category_edit').modal('hide');
          load_categories();
          load_pages();
        });
      });

      $('#page_edit button.btn-primary').click(function(e){
        $('#page_edit form').submit();
      });
      $('#category_edit button.btn-primary').click(function(e){
        $('#category_edit form').submit();
      });
    });
    </script>
</div>
